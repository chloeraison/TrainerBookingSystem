@page
@model TrainerBookingSystem.Web.Pages.DashboardModel
@{
    ViewData["Title"] = "Trainer Dashboard";
    string tabClass(bool active) => active
        ? "display:inline-block;padding:8px 12px;border-bottom:3px solid var(--accent);font-weight:600;"
        : "display:inline-block;padding:8px 12px;border-bottom:3px solid transparent;color:var(--muted);";
}

<h1 style="margin-bottom:6px;">Trainer Dashboard</h1>
<p style="color:var(--muted);margin-top:0;">This week</p>

<nav style="border-bottom:1px solid var(--border);margin-bottom:16px;">
    <a asp-page="/Dashboard" asp-route-view="List"     style="@tabClass(Model.SelectedView == DashboardView.List)">List</a>
    <a asp-page="/Dashboard" asp-route-view="Calendar" style="@tabClass(Model.SelectedView == DashboardView.Calendar)">Calendar</a>
    <a asp-page="/Dashboard" asp-route-view="Tick"     style="@tabClass(Model.SelectedView == DashboardView.Tick)">Tick list</a>
</nav>

<!-- LIST: grouped by day -->
@if (Model.SelectedView == DashboardView.List)
{
    if (!Model.Bookings.Any())
    {
        <p>No bookings yet for this week.</p>
    }
    else
    {
        foreach (var day in Model.WeekByDay)
        {
            <section class="card" style="padding:12px;margin-bottom:12px;">
                <h3 style="margin:0 0 8px 0;">@day.Key:dddd dd MMM</h3>

                @if (!day.Value.Any())
                {
                    <div style="color:var(--muted);">— no sessions —</div>
                }
                else
                {
                    <div style="display:grid;grid-template-columns: 110px 1fr 160px;gap:8px;">
                        @foreach (var b in day.Value)
                        {
                            <div style="font-weight:600;">@b.StartTime:hh\\:mm</div>
                            <div>@b.Client?.Name<br /><span style="color:var(--muted);">@b.SessionType</span></div>
                            <div>
                                <span class="badge">Confirmed</span>
                                <a asp-page="/Bookings/Create" asp-route-date="@b.Date.ToString("yyyy-MM-dd")"
                                   class="btn" style="margin-left:6px;">+ Add</a>
                            </div>
                        }
                    </div>
                }
            </section>
        }
    }
}

<!-- CALENDAR (WEEK GRID): Mon..Sun columns -->
@if (Model.SelectedView == DashboardView.Calendar)
{
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:10px;">
        @foreach (var day in Model.WeekByDay)
        {
            <div class="card" style="padding:10px;min-height:140px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <strong>@day.Key:ddd dd</strong>
                    <a asp-page="/Bookings/Create" asp-route-date="@day.Key.ToString("yyyy-MM-dd")" class="btn" title="Add">+ Add</a>
                </div>

                @if (!day.Value.Any())
                {
                    <div style="color:var(--muted);font-size:.95rem;">— free —</div>
                }
                else
                {
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        @foreach (var b in day.Value)
                        {
                            <div class="card" style="padding:8px;">
                                <div style="font-weight:700;">@b.StartTime:hh\\:mm · @b.Client?.Name</div>
                                <div style="color:var(--muted);">@b.SessionType</div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
}

<!-- TICK LIST: who is booked this week + copy message -->
@if (Model.SelectedView == DashboardView.Tick)
{
    <form method="get" style="margin-bottom:10px;">
        <input type="hidden" name="view" value="Tick" />
        <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" name="showUnbookedOnly" value="true" @(Model.showUnbookedOnly ? "checked" : "") />
            Show unbooked only
        </label>
        <button class="btn" style="margin-left:8px;">Apply</button>
    </form>

    @if (!Model.ClientStatuses.Any())
    {
        <p>No clients yet.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr><th style="width:40%;">Client</th><th>Status</th><th style="width:40%;">Actions</th></tr>
            </thead>
            <tbody>
            @foreach (var cs in Model.ClientStatuses)
            {
                var status = cs.IsBookedThisWeek ? "Booked" : "Not booked";
                <tr>
                    <td>@cs.Client.Name</td>
                    <td>
                        <span class="badge" style="@(cs.IsBookedThisWeek ? "" : "opacity:.75;")">@status</span>
                    </td>
                    <td>
                        <!-- Copy 'your hours this week' message -->
                        <button type="button" class="btn copy-btn"
                                data-text="@cs.ScheduleText.Replace("\"","&quot;").Replace("\n","&#10;")">
                            Copy message
                        </button>

                        <!-- WhatsApp link with prefilled text (desktop/mobile) -->
                        <a class="btn" style="margin-left:6px;"
                           href="https://wa.me/?text=@Uri.EscapeDataString(cs.ScheduleText)" target="_blank" rel="noopener">
                            WhatsApp
                        </a>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
}

@section Scripts {
<script>
  // Copies the schedule text into clipboard
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const text = btn.getAttribute('data-text');
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy message', 1200);
      });
    });
  });
</script>
}
